<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="../../build/p2.js"></script>
    <style>
      body {
        background-color: black;
        margin:0;
        padding:0;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <script>
      var canvas, ctx, w, h, shipSize=0.3, spaceWidth=16, spaceHeight=9,
          world, shipShape, shipBody,
          bulletBodies=[], bulletShape, bulletRadius=0.03,
          asteroidShapes=[], numAsteroidLevels=4, asteroidRadius=0.9, asteroids=[],
          SHIP=Math.pow(2,1),
          BULLET=Math.pow(2,2),
          ASTEROID=Math.pow(2,3);

      init();
      animate();

      function init(){

        // Init canvas
        canvas = document.createElement("canvas");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        document.body.appendChild(canvas);
        w = canvas.width;
        h = canvas.height;

        ctx = canvas.getContext("2d");
        ctx.lineWidth = 0.02;
        ctx.strokeStyle = ctx.fillStyle = 'white';

        // Init p2.js
        world = new p2.World({
          gravity : [0,0],
        });

        // Add ship physics
        shipShape = new p2.Circle(shipSize);
        shipBody = new p2.Body({ mass:1, position:[0,0],angularVelocity:1 });
        shipBody.addShape(shipShape);
        shipShape.collisionGroup = SHIP;
        shipShape.collisionMask = ASTEROID;
        world.addBody(shipBody);

        // Create bullet shape
        bulletShape = new p2.Circle(bulletRadius);
        bulletShape.collisionGroup = BULLET;
        bulletShape.collisionMask = ASTEROID;

        // Add some asteroids
        for(var i=0; i<numAsteroidLevels; i++){
          console.log(asteroidRadius*(numAsteroidLevels-i)/numAsteroidLevels)
          asteroidShapes[i] = new p2.Circle(asteroidRadius*(numAsteroidLevels-i)/numAsteroidLevels);
          asteroidShapes[i].collisionGroup = ASTEROID;
          asteroidShapes[i].collisionMask = BULLET | SHIP;
        }
        for(var i=0; i<10; i++){
          var x = (Math.random()-0.5) * spaceWidth/2,
              y = (Math.random()-0.5) * spaceHeight/2,
              vx = (Math.random()-0.5) * 1,
              vy = (Math.random()-0.5) * 1;
          var asteroidBody = new p2.Body({mass:10,position:[x,y],velocity:[vx,vy]});
          asteroidBody.level = 1;
          asteroidBody.addShape(asteroidShapes[0]);
          asteroids.push(asteroidBody);
          world.addBody(asteroidBody);
        }
      }

      function drawShip(){
        ctx.beginPath();
        var x = shipBody.position[0],
            y = shipBody.position[1],
            radius = shipShape.radius;
        ctx.save();
        ctx.translate(x,y);  // Translate to the center
        ctx.rotate(shipBody.angle);
        ctx.arc(0,0,radius,0,2*Math.PI);
        ctx.moveTo(0,0);
        ctx.lineTo(0,radius);
        ctx.stroke();
        ctx.restore();
        ctx.closePath();
      }

      function drawAsteroids(){
        for(var i=0; i!==asteroids.length; i++){
          ctx.beginPath();
          var a = asteroids[i],
              x = a.position[0],
              y = a.position[1],
              radius = a.shapes[0].radius;
          ctx.save();
          ctx.translate(x,y);  // Translate to the center
          ctx.rotate(a.angle);
          ctx.arc(0,0,radius,0,2*Math.PI);
          ctx.moveTo(0,0);
          ctx.lineTo(0,radius);
          ctx.stroke();
          ctx.restore();
          ctx.closePath();
        }
      }

      function drawBullets(){
        for(var i=0; i!==bulletBodies.length; i++){
          var bulletBody=bulletBodies[i],
              x = bulletBody.position[0],
              y = bulletBody.position[1];
          ctx.beginPath();
          ctx.arc(x,y,bulletRadius,0,2*Math.PI);
          ctx.fill();
          ctx.stroke();
          ctx.closePath();
        }
      }

      function drawBounds(){
        ctx.moveTo(-spaceWidth/2, -spaceHeight/2);
        ctx.lineTo(-spaceWidth/2,  spaceHeight/2);
        ctx.lineTo( spaceWidth/2,  spaceHeight/2);
        ctx.lineTo( spaceWidth/2, -spaceHeight/2);
        ctx.lineTo(-spaceWidth/2, -spaceHeight/2);
        ctx.stroke();
      }

      function render(){
        // Clear the canvas
        ctx.clearRect(0,0,w,h);

        // Transform the canvas
        // Note that we need to flip the y axis since Canvas pixel coordinates
        // goes from top to bottom, while physics does the opposite.
        ctx.save();
        ctx.translate(w/2, h/2);  // Translate to the center
        ctx.scale(50, -50);       // Zoom in and flip y axis

        // Draw all bodies
        drawShip();
        drawBullets();
        drawBounds();
        drawAsteroids();

        // Restore transform
        ctx.restore();
      }

      // Animation loop
      function animate(){
        requestAnimationFrame(animate);

        updatePhysics();

        // Render scene
        render();
      }

      var keyLeft, keyRight, keyUp, keyDown, keyShoot, lastShootTime=world.time;

      function updatePhysics(){

        // Set velocities
        if(keyLeft)       shipBody.angularVelocity =  3;
        else if(keyRight) shipBody.angularVelocity = -3;
        else              shipBody.angularVelocity =  0;

        // Thrust
        if(keyUp){
          var magnitude = 2,
              angle = shipBody.angle + Math.PI / 2;
          shipBody.force[0] += magnitude*Math.cos(angle);
          shipBody.force[1] += magnitude*Math.sin(angle);
        }

        // Shoot
        if(keyShoot && world.time - lastShootTime > 0.2){
          var bulletBody = new p2.Body({ mass:0.05, position:shipBody.position });
          bulletBody.addShape(bulletShape);
          bulletBodies.push(bulletBody);
          var magnitude = 2,
              angle = shipBody.angle + Math.PI / 2;
          bulletBody.velocity[0] += magnitude*Math.cos(angle) + shipBody.velocity[0];
          bulletBody.velocity[1] += magnitude*Math.sin(angle) + shipBody.velocity[1];
          world.addBody(bulletBody);
          lastShootTime = world.time;
          bulletBody.dieTime = world.time + 2;
        }

        for(var i=0; i!==bulletBodies.length; i++){
          var b=bulletBodies[i];

          // If the bullet is old, delete it
          if(b.dieTime <= world.time){
            bulletBodies.splice(i,1);
            world.removeBody(b);
            i--;
            continue;
          }

          // If any body is out of bounds, move it to the other end
          warp(b);
        }

        for(var i=0; i!==asteroids.length; i++){
          var a=asteroids[i];
          warp(a);
        }

        // Warp the ship
        warp(shipBody);

        // Move physics bodies forward in time
        world.step(1/60);
      }

      window.onkeydown = function(evt) {
        handleKey(evt.keyCode,true);
      }

      window.onkeyup = function(evt) {
        handleKey(evt.keyCode,false);
      }

      function handleKey(code,isDown){
        switch(code){
          case 32: keyShoot = isDown; break;
          case 37: keyLeft =  isDown; break;
          case 38: keyUp =    isDown; break;
          case 39: keyRight = isDown; break;
          case 40: keyDown =  isDown; break;
        }
      }

      function warp(body){
        if(body.position[0] >  spaceWidth /2) body.position[0] = -spaceWidth/2;
        if(body.position[1] >  spaceHeight/2) body.position[1] = -spaceHeight/2;
        if(body.position[0] < -spaceWidth /2) body.position[0] =  spaceWidth/2;
        if(body.position[1] < -spaceHeight/2) body.position[1] =  spaceHeight/2;
      }

      function explode(asteroidBody,bulletBody){
        // Remove asteroid
        world.removeBody(asteroidBody);
        asteroids.splice(asteroids.indexOf(asteroidBody),1);

        // Remove bullet
        world.removeBody(bulletBody);
        bulletBodies.splice(bulletBodies.indexOf(bulletBody),1);

        // Add new asteroids
        var x = asteroidBody.position[0],
            y = asteroidBody.position[1];
        if(asteroidBody.level < 4){
          var angleDisturb = Math.PI/2 * Math.random();
          for(var i=0; i<4; i++){
            var angle = Math.PI/2*i+ angleDisturb;
            var r = asteroidBody.shapes[0].radius - asteroidShapes[asteroidBody.level].radius;
            var subAsteroidBody = new p2.Body({
              mass : 10,
              position:[x+r*Math.cos(angle),y+r*Math.sin(angle)],
              velocity : [Math.random()-0.5,Math.random()-0.5],
            });
            subAsteroidBody.addShape(asteroidShapes[asteroidBody.level]);
            subAsteroidBody.level = asteroidBody.level + 1;
            world.addBody(subAsteroidBody);
            asteroids.push(subAsteroidBody);
          }
        }
      }

      world.on("impact",function(evt){
        var bodyA = evt.bodyA,
            bodyB = evt.bodyB;

        if(bodyA.id == shipBody.id || bodyB.id == shipBody.id){
          // Ship collided with something
          var s = bodyA.shapes[0].collisionGroup == SHIP ? bodyA : bodyB,
              otherBody = bodyB==s ? bodyA : bodyB;
          if(otherBody.shapes[0].collisionGroup == ASTEROID){
            console.log("Game over!");
          }

        } else if(bodyA.shapes[0].collisionGroup == BULLET || bodyB.shapes[0].collisionGroup == BULLET){
          // Bullet collided with something
          var bulletBody = bodyA.shapes[0].collisionGroup == BULLET ? bodyA : bodyB,
              otherBody = bodyB==bulletBody ? bodyA : bodyB;

          if(otherBody.shapes[0].collisionGroup == ASTEROID){
            explode(otherBody,bulletBody);
          }
        }
      });
    </script>

  </body>
</html>
