!function(a){function b(a,b,c){vec2.sub(k,a.position,b.position);var d=a.shape.radius,e=b.shape.radius;vec2.sqrLen(k)<(d+e)*(d+e)&&(c.push(a),c.push(b))}function c(a,b,c){vec2.sub(k,a.position,b.position),vec2.rotate(l,m,b.angle),vec2.dot(k,l)<=a.shape.radius&&(c.push(a),c.push(b))}function d(a,b,c){c.push(a),c.push(b)}function e(b,c,d,e){var f=e.length?e.pop():new a.ContactEquation(b,c);f.bi=b,f.bj=c,vec2.sub(f.ni,c.position,b.position),vec2.normalize(f.ni,f.ni),vec2.scale(f.ri,f.ni,b.shape.radius),vec2.scale(f.rj,f.ni,-c.shape.radius),d.push(f)}function f(){}function g(b,c,d,e){var f=e.length?e.pop():new a.ContactEquation(c,b);f.bi=c,f.bj=b;var g=n,h=o;vec2.rotate(f.ni,m,c.angle),vec2.scale(f.rj,f.ni,-b.shape.radius),vec2.sub(g,b.position,c.position);var i=vec2.dot(f.ni,g);vec2.scale(h,f.ni,i),vec2.sub(f.ri,g,h),d.push(f)}function h(){return performance.now?performance.now():performance.webkitNow?performance.webkitNow():((new Date).getTime(),void 0)}var a={},i=Float32Array||Array;vec2.getX=function(a){return a[0]},vec2.getY=function(a){return a[1]},vec2.crossLength=function(a,b){return a[0]*b[1]-a[1]*b[0]},vec2.rotate=function(a,b,c){var d=Math.cos(c),e=Math.sin(c);a[0]=d*b[0]-e*b[1],a[1]=e*b[0]+d*b[1]},a.Shape=function(){},a.Particle=function(){a.Shape.apply(this)},a.Circle=function(b){a.Shape.apply(this),this.radius=b||1},a.Plane=function(){a.Shape.apply(this)},a.Spring=function(a,b,c){c=c||{},this.restLength=c.restLength||1,this.stiffness=c.stiffness||100,this.damping=c.damping||1,this.bodyA=a,this.bodyB=b},a.Body=function(a){a=a||{},this.shape=a.shape,this.mass=a.mass||0,this.invMass=this.mass>0?1/this.mass:0,this.inertia=a.inertia||this.mass,this.invInertia=this.invMass,this.position=a.position||vec2.create(),this.velocity=a.velocity||vec2.create(),this.vlambda=vec2.create(),this.wlambda=0,this.angle=a.angle||0,this.angularVelocity=a.angularVelocity||0,this.force=a.force||vec2.create(),this.angularForce=a.angularForce||0};var j=vec2.create();a.Body.prototype.applyForce=function(a,b){var c=j;vec2.sub(c,b,this.position),vec2.add(this.force,this.force,a);var d=vec2.crossLength(c,a);this.angularForce+=d};var k=vec2.create();mat2.create();var l=vec2.create(),m=vec2.fromValues(0,1),n=(mat2.create(),vec2.create()),o=vec2.create(),p=vec2.create(),q=vec2.create(),r=vec2.create(),s=vec2.create(),t=vec2.create(),u=vec2.create();a.Broadphase=function(){},a.Broadphase.prototype.getCollisionPairs=function(){throw new Error("getCollisionPairs must be implemented in a subclass!")},a.NaiveBroadphase=function(){a.Broadphase.apply(this),this.getCollisionPairs=function(e){for(var f=e.collidingBodies,g=[],h=0,i=f.length;h!==i;h++){var j=f[h],k=j.shape;if(void 0!==k)for(var l=0;l!==h;l++){var m=f[l],n=m.shape;void 0!==n&&(k instanceof a.Circle?n instanceof a.Circle?b(j,m,g):n instanceof a.Particle?d(j,m,g):n instanceof a.Plane&&c(j,m,g):k instanceof a.Particle?n instanceof a.Circle&&d(m,j,g):k instanceof a.Plane&&n instanceof a.Circle&&c(m,j,g))}}return g}},a.NaiveBroadphase.prototype=new a.Broadphase,a.GridBroadphase=function(e,f,g,h,i,j){a.Broadphase.apply(this),i=i||10,j=j||10;var k=(f-e)/i,l=(h-g)/j,m=a.Plane,n=a.Circle,o=a.Particle;this.getCollisionPairs=function(p){for(var q=[],r=p.collidingBodies,s=s=r.length,t=[],u=i*j,v=0;u>v;v++)t.push([]);for(var w=i/(f-e),x=j/(h-g),v=0;v!==s;v++){var y=r[v],z=y.shape;if(void 0!==z)if(z instanceof n)for(var A=vec2.getX(y.position),B=vec2.getY(y.position),C=z.radius,D=Math.floor(w*(A-C-e)),E=Math.floor(x*(B-C-g)),F=Math.floor(w*(A+C-e)),G=Math.floor(x*(B+C-g)),H=D;F>=H;H++)for(var I=E;G>=I;I++){var J=H,K=I;J*(j-1)+K>=0&&u>J*(j-1)+K&&t[J*(j-1)+K].push(y)}else{if(!(z instanceof m))throw new Error("Shape not supported in GridBroadphase!");if(0==y.angle)for(var B=vec2.getY(y.position),H=0;H!==u&&B>g+l*(H-1);H++)for(var I=0;i>I;I++){var J=I,K=Math.floor(x*(l*H-g));t[J*(j-1)+K].push(y)}else if(y.angle==.5*Math.PI)for(var A=vec2.getX(y.position),H=0;H!==u&&A>e+k*(H-1);H++)for(var I=0;j>I;I++){var K=I,J=Math.floor(w*(k*H-e));t[J*(j-1)+K].push(y)}else for(var H=0;H!==u;H++)t[H].push(y)}}for(var v=0;v!==u;v++)for(var L=t[v],H=0,M=L.length;H!==M;H++)for(var y=L[H],z=y.shape,I=0;I!==H;I++){var N=L[I],O=N.shape;z instanceof a.Circle?O instanceof n?b(y,N,q):O instanceof o?d(y,N,q):O instanceof m&&c(y,N,q):z instanceof o?O instanceof n&&d(N,y,q):z instanceof m&&O instanceof n&&c(N,y,q)}return q}},a.GridBroadphase.prototype=new a.Broadphase,a.World=function(b){b=b||{},this.springs=[],this.bodies=[],this.solver=b.solver||new a.GSSolver,this.contacts=[],this.oldContacts=[],this.collidingBodies=[],this.gravity=b.gravity||vec2.fromValues(0,-9.78),this.doProfiling=b.doProfiling||!1,this.lastStepTime=0,this.broadphase=b.broadphase||new a.NaiveBroadphase},a.World.prototype.step=function(b){var c,d,i=this.doProfiling,j=this.springs.length,k=this.springs,l=this.bodies,m=(this.collidingBodies,this.gravity),n=this.solver,o=this.bodies.length,v=this.broadphase;i&&(c=h(),vecCount=0,matCount=0);for(var w=0;w!==o;w++){var x=l[w].force;vec2.add(x,x,m)}for(var w=0;w!==j;w++){var y=k[w],z=y.stiffness,A=y.damping,B=y.restLength,C=y.bodyA,D=y.bodyB,E=p,F=q,G=r,H=s;vec2.sub(E,C.position,D.position),vec2.sub(G,C.velocity,D.velocity);var I=vec2.len(E);vec2.normalize(F,E),vec2.scale(H,F,z*(I-B)+A*vec2.dot(G,F)),vec2.sub(C.force,C.force,H),vec2.add(D.force,D.force,H)}for(var J=v.getCollisionPairs(this),K=this.contacts.concat(this.oldContacts),L=this.contacts=[],M=a.Circle,N=a.Plane,O=a.Particle,w=0,P=J.length;w!==P;w+=2){var Q=J[w],R=J[w+1],S=Q.shape,T=R.shape;S instanceof a.Circle?T instanceof M?e(Q,R,L,K):T instanceof O?f(Q,R,L,K):T instanceof N&&g(Q,R,L,K):S instanceof O?T instanceof M&&f(R,Q,L,K):S instanceof N&&T instanceof M&&g(R,Q,L,K)}this.oldContacts=K;for(var w=0,U=L.length;w!==U;w++)n.addEquation(L[w]);n.solve(b,this),n.removeAllEquations();for(var V=t,W=u,w=0;w!==o;w++){var X=l[w];if(X.mass>0){var Y=1/X.mass,H=X.force,Z=X.position,$=X.velocity;X.angularVelocity+=X.angularForce*X.invInertia*b,X.angle+=X.angularVelocity*b,vec2.scale(V,H,b*Y),vec2.add($,V,$),vec2.scale(W,$,b),vec2.add(Z,Z,W)}}for(var w=0;w!==o;w++){var Q=l[w];vec2.set(Q.force,0,0),Q.angularForce=0}i&&(d=h(),this.lastStepTime=d-c,this.vecCreations=vecCount,this.matCreations=matCount)},a.World.prototype.addSpring=function(a){this.springs.push(a)},a.World.prototype.removeSpring=function(a){var b=this.springs.indexOf(a);-1===b&&this.springs.splice(b,1)},a.World.prototype.addBody=function(a){this.bodies.push(a),this.collidingBodies.push(a)},a.World.prototype.removeBody=function(a){var b=this.bodies.indexOf(a);-1===b&&this.bodies.splice(b,1)},a.Solver=function(){this.equations=[]},a.Solver.prototype.solve=function(){return 0},a.Solver.prototype.addEquation=function(a){this.equations.push(a)},a.Solver.prototype.removeEquation=function(a){var b=this.equations.indexOf(a);-1!=b&&this.equations.splice(b,1)},a.Solver.prototype.removeAllEquations=function(){this.equations=[]},a.GSSolver=function(){a.Solver.call(this),this.iterations=10,this.h=1/60,this.k=1e7,this.d=6,this.a=0,this.b=0,this.eps=0,this.tolerance=0,this.setSpookParams(this.k,this.d),this.debug=!1,this.arrayStep=30,this.lambda=new i(this.arrayStep),this.Bs=new i(this.arrayStep),this.invCs=new i(this.arrayStep)},a.GSSolver.prototype=new a.Solver,a.GSSolver.prototype.setSpookParams=function(a,b){var c=this.h;this.k=a,this.d=b,this.a=4/(c*(1+4*b)),this.b=4*b/(1+4*b),this.eps=4/(c*c*a*(1+4*b))},a.GSSolver.prototype.solve=function(a,b){var c=(this.d,this.k,0),d=this.iterations,e=this.tolerance*this.tolerance,f=this.a,g=this.b,h=this.eps,j=this.equations,k=j.length,l=b.bodies,m=b.bodies.length,n=a;this.lambda.length<k&&(this.lambda=new i(k+this.arrayStep),this.Bs=new i(k+this.arrayStep),this.invCs=new i(k+this.arrayStep));for(var o=this.invCs,p=this.Bs,q=this.lambda,r=0;r!==k;r++){var s=j[r];q[r]=0,p[r]=s.computeB(f,g,n),o[r]=1/s.computeC(h)}var t,s,u,v,w,x,y;if(0!==k){var r,z,A,B,C;for(r=0;r!==m;r++){var g=l[r],D=g.vlambda;vec2.set(D,0,0),g.wlambda=0}for(c=0;c!==d;c++){for(w=0,z=0;z!==k;z++)s=j[z],B=s.maxForce,A=s.minForce,t=p[z],u=o[z],y=q[z],x=s.computeGWlambda(h),v=u*(t-x-h*y),C=y+v,A>C?v=A-y:C>B&&(v=B-y),q[z]+=v,w+=Math.abs(v),s.addToWlambda(v);if(e>=w*w)break}for(r=0;r!==m;r++){var g=l[r],E=g.velocity;vec2.add(E,E,g.vlambda),g.angularVelocity+=g.wlambda}}return errorTot=w,c},a.Equation=function(a,b,c,d){this.id=-1,this.minForce="undefined"==typeof c?-1e6:c,this.maxForce="undefined"==typeof d?1e6:d,this.bi=a,this.bj=b},a.Equation.prototype.constructor=a.Equation,a.ContactEquation=function(b,c){a.Equation.call(this,b,c,0,1e6),this.penetration=0,this.ri=vec2.create(),this.penetrationVec=vec2.create(),this.rj=vec2.create(),this.ni=vec2.create(),this.rixn=vec2.create(),this.rjxn=vec2.create(),this.rixw=vec2.create(),this.rjxw=vec2.create(),this.relVel=vec2.create(),this.relForce=vec2.create()},a.ContactEquation.prototype=new a.Equation,a.ContactEquation.prototype.constructor=a.ContactEquation,a.ContactEquation.prototype.computeB=function(a,b,c){var d=this.bi,e=this.bj,f=this.ri,g=this.rj,h=d.position,i=e.position,j=d.velocity,k=d.angularVelocity,l=d.force,m=d.angularForce,n=e.velocity,o=e.angularVelocity,p=e.force,q=e.angularForce,r=(this.relVel,this.relForce,this.penetrationVec),s=d.invMass,t=e.invMass,u=d.invInertia,v=e.invInertia,w=this.ni,x=this.rixn=vec2.crossLength(f,w),y=this.rjxn=vec2.crossLength(g,w);vec2.set(r,0,0),vec2.add(r,i,g),vec2.sub(r,r,h),vec2.sub(r,r,f);var z=vec2.dot(w,r),A=vec2.dot(n,w)-vec2.dot(j,w)+o*y-k*x,B=vec2.dot(p,w)*t-vec2.dot(l,w)*s+v*q*y-u*m*x,C=-z*a-A*b-c*B;return C},a.ContactEquation.prototype.computeC=function(a){var b=this.bi,c=this.bj,d=this.rixn,e=this.rjxn,f=b.invMass,g=c.invMass,h=f+g+a,i=b.invInertia,j=c.invInertia;return h+=i*d*d,h+=j*e*e};var v=vec2.create();a.ContactEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=v,d=0;return vec2.sub(c,b.vlambda,a.vlambda),d+=vec2.dot(c,this.ni),d-=a.wlambda*this.rixn,d+=b.wlambda*this.rjxn};var w=vec2.create();a.ContactEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=this.rixn,e=this.rjxn,f=b.invMass,g=c.invMass,h=this.ni,i=w;vec2.scale(i,h,f*a),vec2.sub(b.vlambda,b.vlambda,i),vec2.scale(i,h,g*a),vec2.add(c.vlambda,c.vlambda,i),b.wlambda-=b.invInertia*d*a,c.wlambda+=c.invInertia*e*a},"undefined"!=typeof module?module.exports=a:this.p2=a}.apply(this);