<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>p2.js performance test</title>
  </head>
  <style>
  td,th {
    padding-right: 20px;
  }
  td.name {
    text-decoration: underline;
    cursor: pointer;
  }
  th {
    text-align: left;
  }
  td.ops {
    text-align: right;
  }
  </style>
  <body>
    <h1>p2.js performance test</h1>
    <p>Used to incrementally improve performance of parts of the lib, across browsers. Work flow:</p>
    <ol>
      <li>Optional: create new benchmark</li>
      <li>Run the benchmark you are interested in</li>
      <li>Click "Save reference values"</li>
      <li>Optimize and rebuild p2.js</li>
      <li>Run benchmark again. If your optimizations were good, the "relative" column will display a number larger than 1!</li>
    </ol>
    <table id="results">
      <thead>
        <th>name</th>
        <th>ops/s</th>
        <th>Â±%</th>
        <th>samples</th>
        <th>relative</th>
        <th>status</th>
      </thead>
    </table>
    <p>
      <button onmouseup="javascript:runAll()">Run all</button> <button onmouseup="javascript:saveRefs()">Save reference values</button>
    </p>
    <script src="../build/p2.js"></script>
    <script src="../node_modules/benchmark/node_modules/lodash/index.js"></script>
    <script src="../node_modules/benchmark/node_modules/platform/platform.js"></script>
    <script src="../node_modules/benchmark/benchmark.js"></script>
    <script src="http://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script>

      window.currentResults = {};

      var benchmarks = [{
        name: 'Equation.prototype.computeGiMGt',
        setup: function(){
          eq = new p2.Equation(new p2.Body(), new p2.Body());
        },
        fn: function() {
          eq.computeGiMGt();
        }
      },{
        name: 'Equation.prototype.update',
        setup: function(){
          eq = new p2.Equation(new p2.Body(), new p2.Body());
        },
        fn: function() {
          eq.update();
        }
      },{
        name: 'Body.prototype.integrate',
        setup: function(){
          body = new p2.Body();
        },
        fn: function() {
          body.integrate(0.1);
        }
      },{
        name: 'Body.prototype.updateAABB (circle)',
        setup: function(){
          body = new p2.Body();
          body.addShape(new p2.Circle());
        },
        fn: function() {
          body.updateAABB();
        }
      },{
        name: 'Body.prototype.updateAABB (box)',
        setup: function(){
          body = new p2.Body();
          body.addShape(new p2.Box());
        },
        fn: function() {
          body.updateAABB();
        }
      }];

      window.onload = function(){

        var referenceResults = localStorage.getItem('referenceResults');
        if(referenceResults){
          referenceResults = JSON.parse(referenceResults);
        }

        function extend(a,b){
          for(var key in b){
            a[key] = b[key];
          }
        }

        extend(Benchmark.options, {
          async: true,
          setup: function(event){
            var def = benchmarks[this.index];
            if(def.setup){
              def.setup();
            }
          }
        });

        var suite = new Benchmark.Suite();

        for (var i = 0; i < benchmarks.length; i++) {
          var benchmark = benchmarks[i];
          benchmark.index = i;

          var hash = window.location.hash;
          if(!hash || hash === '#' + encodeURIComponent(benchmark.name)){
            suite.add(benchmark);
          }
        }

        suite
          .on('cycle', function(event) {
            var bench = event.target,
                error = bench.error,
                hz = bench.hz,
                id = bench.index,
                stats = bench.stats,
                size = stats.sample.length;

            if (error) {
              console.error(error);
            } else {
              var name = (bench.name || (_.isNaN(id) ? id : '<Test #' + id + '>'));
              var samples = size + ' run' + (size == 1 ? '' : 's');
              var ops = (hz.toFixed(hz < 100 ? 2 : 0));
              var plusMinus = stats.rme.toFixed(2);
              $("#bench-" + id + " td.ops").text(formatNumber(ops,'.'));
              $("#bench-" + id + " td.pm").text(plusMinus);
              $("#bench-" + id + " td.samples").text(samples);
              $("#bench-" + id + " td.rel").text(referenceResults && referenceResults[bench.name] ? (ops / referenceResults[bench.name]).toFixed(2) + 'x' : '');
              $("#bench-" + id + " td.status").text('done');

              window.currentResults[bench.name] = ops;
            }
          });

          for(var i=0; i<suite.length; i++){
            var name = suite[i].name;
            $("#results").append([
              "<tr id='bench-" + suite[i].index + "'>",
              "<td class='name'><a onmouseup='javascript:goToBench(\"" + encodeURIComponent(name) + "\")'>" + name + "</a></td>",
              "<td class='ops'></td>",
              "<td class='pm'></td>",
              "<td class='samples'></td>",
              "<td class='rel'></td>",
              "<td class='status'></td>",
              "</tr>"
            ].join(''));
          }

          suite.run({ 'async': true });
      };

      function saveRefs(){
        localStorage.setItem('referenceResults', JSON.stringify(window.currentResults));
      }

      function goToBench(name){
        location.href = '#' + name;
        location.reload();
      }

      function runAll(){
        location.href = '#';
        location.reload();
      }

      function formatNumber(number,delimiter) {
        number = String(number).split('.');
        return number[0].replace(/(?=(?:\d{3})+$)(?!\b)/g, delimiter) +
          (number[1] ? '.' + number[1] : '');
      }
    </script>
  </body>
</html>
